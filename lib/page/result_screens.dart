import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:billo_app/models/bill_model.dart';
import 'package:billo_app/utils/price_utils.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import 'package:billo_app/page/splitbill_screens.dart';

class ResultScreen extends StatelessWidget {
  final BillData billData;

  const ResultScreen({super.key, required this.billData});

  final Color _primaryColor = const Color(0xFF37474F);
  final Color _accentColor = const Color(0xFF26A69A);
  final Color _bgColor = const Color(0xFFF5F7FA);
  final Color _surfaceColor = Colors.white;
  final Color _borderColor = const Color(0xFFE1E5E9);
  final Color _textSecondary = const Color(0xFF64748B);
  final Color _successColor = const Color(0xFF4CAF50);

  Future<void> _shareToSpecificParticipant(Participant participant) async {
    try {
      final splitResult = billData.calculateSplit();
      final amount = splitResult[participant.id] ?? 0;

      if (amount <= 0) return;

      // Format phone number properly
      String phoneNumber = participant.phoneNumber.trim();
      
      // Remove any non-digit characters except +
      phoneNumber = phoneNumber.replaceAll(RegExp(r'[^\d+]'), '');
      
      // Handle various phone number formats
      if (phoneNumber.startsWith('0')) {
        phoneNumber = '62${phoneNumber.substring(1)}';
      } else if (phoneNumber.startsWith('+62')) {
        phoneNumber = phoneNumber.substring(1); // Remove +
      } else if (!phoneNumber.startsWith('62')) {
        phoneNumber = '62$phoneNumber';
      }

      // Ensure phone number only contains digits
      phoneNumber = phoneNumber.replaceAll(RegExp(r'[^\d]'), '');

      // Build message
      final StringBuffer message = StringBuffer();
      message.writeln('Hi ${participant.name}!');
      message.writeln();
      message.writeln('üìã *YOUR BILL SPLIT DETAIL*');
      message.writeln();

      // Get items assigned to this participant
      final participantItems = billData.items
          .where((item) => item.assignedTo.contains(participant.id))
          .toList();

      if (participantItems.isNotEmpty) {
        message.writeln('üìù *YOUR ITEMS:*');
        message.writeln();

        for (var item in participantItems) {
          final totalParticipants = item.assignedTo.length;
          final yourShare = item.totalPrice / totalParticipants;

          message.writeln('*${item.name.toUpperCase()}*');
          message.writeln('Quantity: ${item.quantity}');
          message.writeln('Price/Unit: ${PriceUtils.formatPrice(item.pricePerUnit)}');
          message.writeln('Total: ${PriceUtils.formatPrice(item.totalPrice)}');
          message.writeln('Shared by: $totalParticipants people');
          message.writeln('Your share: ${PriceUtils.formatPrice(yourShare)}');
          message.writeln();
        }
      } else {
        message.writeln('üìù *YOUR ITEMS:*');
        message.writeln('No items assigned');
        message.writeln();
      }

      message.writeln('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
      message.writeln();
      message.writeln('üí∞ *PAYMENT SUMMARY*');
      message.writeln();
      message.writeln('Total Amount to Pay: *${PriceUtils.formatPrice(amount)}*');
      message.writeln();
      message.writeln();
      message.writeln('_Generated by Billo App_');
      message.writeln('_Please make your payment. Thank you!_');

      // Encode the message for URL
      final encodedMessage = Uri.encodeComponent(message.toString());
      
      // Use WhatsApp API URL with proper formatting
      final url = 'https://wa.me/$phoneNumber?text=$encodedMessage';
      
      await _launchWhatsAppUrl(url);
      
    } catch (e) {
      print('Error sharing to WhatsApp: $e');
      rethrow;
    }
  }

  Future<void> _launchWhatsAppUrl(String url) async {
    try {
      final uri = Uri.parse(url);
      
      if (await canLaunchUrl(uri)) {
        await launchUrl(
          uri,
          mode: LaunchMode.externalApplication,
        );
      } else {
        // If can't launch with wa.me, try with api.whatsapp.com
        final match = RegExp(r'wa\.me/(\d+)\?text=(.*)').firstMatch(url);
        if (match != null) {
          final phone = match.group(1);
          final text = match.group(2);
          final fallbackUrl = 'https://api.whatsapp.com/send/?phone=$phone&text=$text';
          
          final fallbackUri = Uri.parse(fallbackUrl);
          if (await canLaunchUrl(fallbackUri)) {
            await launchUrl(
              fallbackUri,
              mode: LaunchMode.externalApplication,
            );
          } else {
            throw 'Could not launch WhatsApp';
          }
        } else {
          throw 'Invalid URL format';
        }
      }
    } catch (e) {
      print('Launch URL error: $e');
      throw 'Could not launch WhatsApp: $e';
    }
  }

  @override
  Widget build(BuildContext context) {
    final splitResult = billData.calculateSplit();

    return Scaffold(
      backgroundColor: _bgColor,
      appBar: AppBar(
        title: Text(
          'Hasil Pembagian',
          style: TextStyle(
            color: Colors.white,
            fontWeight: FontWeight.w800,
            fontSize: 34,
            fontFamily: 'SG03Custom',
          ),
        ),
        centerTitle: true,
        backgroundColor: _primaryColor,
        elevation: 0,
        shape: const RoundedRectangleBorder(
          borderRadius: BorderRadius.only(
            bottomLeft: Radius.circular(20),
            bottomRight: Radius.circular(20),
          ),
        ),
      ),
      body: SafeArea(
        child: SingleChildScrollView(
          physics: const BouncingScrollPhysics(),
          padding: const EdgeInsets.fromLTRB(24, 16, 24, 32),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              _buildSummaryCard(splitResult),
              const SizedBox(height: 16),
              _buildItemsSection(),
              const SizedBox(height: 16),
              _buildParticipantsSection(splitResult, context),
              const SizedBox(height: 16),
              _buildActionButtons(context),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildSummaryCard(Map<String, double> splitResult) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [_primaryColor, _primaryColor.withOpacity(0.9)],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 25,
            offset: const Offset(0, 12),
          ),
        ],
      ),
      child: Column(
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Container(
                padding: const EdgeInsets.all(10),
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.2),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: FaIcon(
                  FontAwesomeIcons.receipt,
                  color: Colors.white,
                  size: 22,
                ),
              ),
              const SizedBox(width: 16),
              Text(
                'Ringkasan Pembagian',
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.w800,
                  color: Colors.white,
                ),
              ),
            ],
          ),
          const SizedBox(height: 24),
          Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: Colors.white.withOpacity(0.1),
              borderRadius: BorderRadius.circular(18),
            ),
            child: Column(
              children: [
                _buildSummaryRow(
                  icon: FontAwesomeIcons.moneyBillWave,
                  label: 'Total Tagihan',
                  value: PriceUtils.formatPrice(billData.totalAmount),
                  isTotal: true,
                ),
                const SizedBox(height: 16),
                Divider(color: Colors.white.withOpacity(0.2), height: 1),
                const SizedBox(height: 16),
                Row(
                  children: [
                    Expanded(
                      child: _buildSummaryDetailItem(
                        icon: FontAwesomeIcons.basketShopping,
                        label: 'Jumlah Item',
                        value: '${billData.items.length} item',
                      ),
                    ),
                    Container(
                      width: 1,
                      height: 40,
                      color: Colors.white.withOpacity(0.2),
                    ),
                    Expanded(
                      child: _buildSummaryDetailItem(
                        icon: FontAwesomeIcons.users,
                        label: 'Jumlah Orang',
                        value: '${billData.participants.length} orang',
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 12),
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: _accentColor,
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Row(
                    crossAxisAlignment: CrossAxisAlignment.center,
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      FaIcon(
                        FontAwesomeIcons.calendar,
                        color: Colors.white,
                        size: 16,
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Text(
                          DateFormat(
                            'dd MMMM yyyy, HH:mm',
                          ).format(billData.createdDate),
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 14,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSummaryRow({
    required IconData icon,
    required String label,
    required String value,
    bool isTotal = false,
  }) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.start,
      crossAxisAlignment: CrossAxisAlignment.center,
      children: [
        Container(
          height: 40,
          width: 40,
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: Colors.white.withOpacity(0.2),
            borderRadius: BorderRadius.circular(10),
          ),
          child: FaIcon(icon, color: Colors.white, size: 24),
        ),
        const SizedBox(width: 12),
        Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              label,
              style: TextStyle(
                color: Colors.white,
                fontSize: 16,
                fontWeight: FontWeight.w600,
              ),
            ),
            Text(
              value,
              style: TextStyle(
                color: Colors.white,
                fontSize: isTotal ? 28 : 18,
                fontWeight: isTotal ? FontWeight.w900 : FontWeight.w700,
                fontFamily: 'monospace',
              ),
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildSummaryDetailItem({
    required IconData icon,
    required String label,
    required String value,
  }) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 12),
      child: Column(
        children: [
          FaIcon(icon, color: Colors.white.withOpacity(0.8), size: 16),
          const SizedBox(height: 8),
          Text(
            label,
            style: TextStyle(
              color: Colors.white.withOpacity(0.7),
              fontSize: 12,
            ),
          ),
          const SizedBox(height: 4),
          Text(
            value,
            style: TextStyle(
              color: Colors.white,
              fontSize: 14,
              fontWeight: FontWeight.w700,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildItemsSection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
          child: Row(
            children: [
              Container(
                padding: const EdgeInsets.all(6),
                decoration: BoxDecoration(
                  color: _accentColor.withOpacity(0.1),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: FaIcon(
                  FontAwesomeIcons.listCheck,
                  size: 16,
                  color: _accentColor,
                ),
              ),
              const SizedBox(width: 12),
              Text(
                'Detail Item',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w800,
                  color: _primaryColor,
                ),
              ),
              const Spacer(),
              Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 12,
                  vertical: 6,
                ),
                decoration: BoxDecoration(
                  color: _primaryColor.withOpacity(0.1),
                  borderRadius: BorderRadius.circular(20),
                ),
                child: Text(
                  '${billData.items.length} items',
                  style: TextStyle(
                    fontSize: 12,
                    fontWeight: FontWeight.w600,
                    color: _primaryColor,
                  ),
                ),
              ),
            ],
          ),
        ),
        const SizedBox(height: 12),
        ...billData.items.asMap().entries.map((entry) {
          final index = entry.key;
          final item = entry.value;
          final assignedNames = item.assignedTo
              .map((id) {
                final participant = billData.participants.firstWhere(
                  (p) => p.id == id,
                  orElse: () =>
                      Participant(id: '', name: 'Unknown', phoneNumber: ''),
                );
                return participant.name;
              })
              .join(', ');

          return Container(
            margin: const EdgeInsets.only(bottom: 12),
            decoration: BoxDecoration(
              color: _surfaceColor,
              borderRadius: BorderRadius.circular(18),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.05),
                  blurRadius: 15,
                  offset: const Offset(0, 6),
                ),
              ],
            ),
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Expanded(
                        child: Row(
                          children: [
                            Container(
                              width: 32,
                              height: 32,
                              decoration: BoxDecoration(
                                color: _accentColor.withOpacity(0.1),
                                borderRadius: BorderRadius.circular(8),
                              ),
                              child: Center(
                                child: Text(
                                  '${index + 1}',
                                  style: TextStyle(
                                    fontSize: 14,
                                    fontWeight: FontWeight.w700,
                                    color: _accentColor,
                                  ),
                                ),
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: Text(
                                item.name,
                                style: TextStyle(
                                  fontSize: 16,
                                  fontWeight: FontWeight.w700,
                                  color: _primaryColor,
                                ),
                                maxLines: 2,
                                overflow: TextOverflow.ellipsis,
                              ),
                            ),
                          ],
                        ),
                      ),
                      Text(
                        PriceUtils.formatPrice(item.totalPrice),
                        style: TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.w800,
                          color: _accentColor,
                          fontFamily: 'monospace',
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 12),
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: _bgColor,
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Row(
                      children: [
                        _buildItemDetail(
                          icon: FontAwesomeIcons.hashtag,
                          label: 'Qty: ${item.quantity}',
                        ),
                        Container(
                          width: 1,
                          height: 20,
                          color: _borderColor,
                          margin: const EdgeInsets.symmetric(horizontal: 12),
                        ),
                        _buildItemDetail(
                          icon: FontAwesomeIcons.tag,
                          label:
                              '@ ${PriceUtils.formatPrice(item.pricePerUnit)}',
                        ),
                        const Spacer(),
                        Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 12,
                            vertical: 6,
                          ),
                          decoration: BoxDecoration(
                            color: _accentColor.withOpacity(0.1),
                            borderRadius: BorderRadius.circular(20),
                          ),
                          child: Text(
                            '${item.assignedTo.length} orang',
                            style: TextStyle(
                              fontSize: 12,
                              fontWeight: FontWeight.w600,
                              color: _accentColor,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 10),
                  Row(
                    children: [
                      FaIcon(
                        FontAwesomeIcons.users,
                        size: 12,
                        color: _textSecondary,
                      ),
                      const SizedBox(width: 8),
                      Expanded(
                        child: Text(
                          'Dibagi oleh: $assignedNames',
                          style: TextStyle(fontSize: 13, color: _textSecondary),
                          maxLines: 2,
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                      if (item.assignedTo.isNotEmpty)
                        Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 12,
                            vertical: 4,
                          ),
                          decoration: BoxDecoration(
                            color: _primaryColor.withOpacity(0.05),
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: Text(
                            'Per orang: ${PriceUtils.formatPrice(item.totalPrice / item.assignedTo.length)}',
                            style: TextStyle(
                              fontSize: 12,
                              fontWeight: FontWeight.w600,
                              color: _primaryColor,
                            ),
                          ),
                        ),
                    ],
                  ),
                ],
              ),
            ),
          );
        }).toList(),
      ],
    );
  }

  Widget _buildItemDetail({required IconData icon, required String label}) {
    return Row(
      children: [
        FaIcon(icon, size: 12, color: _textSecondary),
        const SizedBox(width: 6),
        Text(
          label,
          style: TextStyle(
            fontSize: 13,
            color: _textSecondary,
            fontWeight: FontWeight.w500,
          ),
        ),
      ],
    );
  }

  Widget _buildParticipantsSection(Map<String, double> splitResult, BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
          child: Row(
            children: [
              Container(
                padding: const EdgeInsets.all(6),
                decoration: BoxDecoration(
                  color: _accentColor.withOpacity(0.1),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: FaIcon(
                  FontAwesomeIcons.userCheck,
                  size: 16,
                  color: _accentColor,
                ),
              ),
              const SizedBox(width: 12),
              Text(
                'Hasil Pembagian',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w800,
                  color: _primaryColor,
                ),
              ),
              const Spacer(),
              Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 12,
                  vertical: 6,
                ),
                decoration: BoxDecoration(
                  color: _accentColor.withOpacity(0.1),
                  borderRadius: BorderRadius.circular(20),
                ),
                child: Text(
                  '${billData.participants.length} participants',
                  style: TextStyle(
                    fontSize: 12,
                    fontWeight: FontWeight.w600,
                    color: _accentColor,
                  ),
                ),
              ),
            ],
          ),
        ),
        const SizedBox(height: 12),
        ...billData.participants.map((participant) {
          final amount = splitResult[participant.id] ?? 0;
          final hasPayment = amount > 0;

          return Container(
            margin: const EdgeInsets.only(bottom: 16),
            decoration: BoxDecoration(
              color: _surfaceColor,
              borderRadius: BorderRadius.circular(18),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.05),
                  blurRadius: 15,
                  offset: const Offset(0, 6),
                ),
              ],
            ),
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Expanded(
                        child: Row(
                          children: [
                            Container(
                              width: 40,
                              height: 40,
                              decoration: BoxDecoration(
                                gradient: LinearGradient(
                                  colors: hasPayment
                                      ? [
                                          _accentColor,
                                          _accentColor.withOpacity(0.8),
                                        ]
                                      : [
                                          _textSecondary,
                                          _textSecondary.withOpacity(0.8),
                                        ],
                                  begin: Alignment.topLeft,
                                  end: Alignment.bottomRight,
                                ),
                                borderRadius: BorderRadius.circular(12),
                              ),
                              child: Center(
                                child: Text(
                                  participant.name[0].toUpperCase(),
                                  style: TextStyle(
                                    color: Colors.white,
                                    fontSize: 18,
                                    fontWeight: FontWeight.w800,
                                  ),
                                ),
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    participant.name,
                                    style: TextStyle(
                                      fontSize: 16,
                                      fontWeight: FontWeight.w800,
                                      color: _primaryColor,
                                    ),
                                  ),
                                  const SizedBox(height: 2),
                                  Row(
                                    children: [
                                      FaIcon(
                                        FontAwesomeIcons.phone,
                                        size: 10,
                                        color: _textSecondary,
                                      ),
                                      const SizedBox(width: 6),
                                      Text(
                                        participant.phoneNumber,
                                        style: TextStyle(
                                          fontSize: 13,
                                          color: _textSecondary,
                                        ),
                                      ),
                                    ],
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),
                      if (hasPayment)
                        Container(
                          padding: const EdgeInsets.all(8),
                          decoration: BoxDecoration(
                            color: _accentColor.withOpacity(0.1),
                            borderRadius: BorderRadius.circular(10),
                          ),
                          child: FaIcon(
                            FontAwesomeIcons.share,
                            size: 18,
                            color: _accentColor,
                          ),
                        ),
                    ],
                  ),
                  const SizedBox(height: 16),
                  Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: hasPayment
                          ? _successColor.withOpacity(0.1)
                          : _bgColor,
                      borderRadius: BorderRadius.circular(14),
                      border: Border.all(
                        color: hasPayment
                            ? _successColor.withOpacity(0.3)
                            : _borderColor,
                        width: 1.5,
                      ),
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              hasPayment
                                  ? 'Jumlah yang Harus Dibayar'
                                  : 'Tidak Ada Pembayaran',
                              style: TextStyle(
                                fontSize: 14,
                                fontWeight: FontWeight.w600,
                                color: hasPayment
                                    ? _successColor
                                    : _textSecondary,
                              ),
                            ),
                            if (!hasPayment) const SizedBox(height: 4),
                            if (hasPayment)
                              Text(
                                PriceUtils.formatPrice(amount),
                                style: TextStyle(
                                  fontSize: 24,
                                  fontWeight: FontWeight.w900,
                                  color: _successColor,
                                  fontFamily: 'monospace',
                                ),
                              )
                            else
                              Container(
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 12,
                                  vertical: 6,
                                ),
                                decoration: BoxDecoration(
                                  color: _textSecondary.withOpacity(0.1),
                                  borderRadius: BorderRadius.circular(20),
                                ),
                                child: Text(
                                  'GRATIS',
                                  style: TextStyle(
                                    fontSize: 12,
                                    fontWeight: FontWeight.w800,
                                    color: _textSecondary,
                                  ),
                                ),
                              ),
                            if (hasPayment) const SizedBox(height: 4),
                            if (hasPayment)
                              Text(
                                'Termasuk pajak & layanan',
                                style: TextStyle(
                                  fontSize: 11,
                                  color: _textSecondary,
                                ),
                              ),
                          ],
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 12),
                  if (hasPayment)
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton.icon(
                        onPressed: () async {
                          try {
                            await _shareToSpecificParticipant(participant);
                          } catch (e) {
                            // Show error message to user
                            ScaffoldMessenger.of(context).showSnackBar(
                              SnackBar(
                                content: Text(
                                  'Gagal membuka WhatsApp: ${e.toString().replaceAll('Could not launch WhatsApp: ', '')}',
                                ),
                                backgroundColor: Colors.red,
                                duration: const Duration(seconds: 3),
                              ),
                            );
                          }
                        },
                        icon: FaIcon(
                          FontAwesomeIcons.whatsapp,
                          size: 18,
                          color: Colors.white,
                        ),
                        label: Text(
                          'Kirim ke WhatsApp ${participant.name}',
                          style: TextStyle(
                            fontSize: 14,
                            fontWeight: FontWeight.w600,
                            color: Colors.white,
                          ),
                        ),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: _successColor,
                          padding: const EdgeInsets.symmetric(vertical: 14),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                          elevation: 2,
                        ),
                      ),
                    ),
                ],
              ),
            ),
          );
        }).toList(),
      ],
    );
  }

  Widget _buildActionButtons(BuildContext context) {
    return Column(
      children: [
        Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(18),
            border: Border.all(color: _accentColor, width: 1.5),
          ),
          child: Material(
            color: Colors.transparent,
            borderRadius: BorderRadius.circular(18),
            child: InkWell(
              onTap: () {
                Navigator.of(context).pushAndRemoveUntil(
                  MaterialPageRoute(
                    builder: (context) => const SplitBillScreen(
                      initialItems: [],
                      receiptImagePath: null,
                    ),
                  ),
                  (route) => false,
                );
              },
              borderRadius: BorderRadius.circular(18),
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 24,
                  vertical: 20,
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Container(
                      padding: const EdgeInsets.all(10),
                      decoration: BoxDecoration(
                        color: _accentColor.withOpacity(0.1),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: FaIcon(
                        FontAwesomeIcons.receipt,
                        color: _accentColor,
                        size: 22,
                      ),
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            'Buat Tagihan Baru',
                            style: TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.w800,
                              color: _accentColor,
                            ),
                          ),
                          const SizedBox(height: 2),
                          Text(
                            'Mulai pembagian tagihan baru',
                            style: TextStyle(
                              fontSize: 13,
                              color: _textSecondary,
                            ),
                          ),
                        ],
                      ),
                    ),
                    FaIcon(
                      FontAwesomeIcons.chevronRight,
                      color: _accentColor,
                      size: 18,
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
        const SizedBox(height: 16),
        _buildBackToHomeButton(context),
      ],
    );
  }

  Widget _buildBackToHomeButton(BuildContext context) {
    return Center(
      child: Container(
        width: double.infinity,
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: _borderColor, width: 1.5),
        ),
        child: TextButton(
          onPressed: () {
            Navigator.of(context).popUntil((route) => route.isFirst);
          },
          child: Row(
            crossAxisAlignment: CrossAxisAlignment.center,
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              FaIcon(FontAwesomeIcons.house, size: 16, color: _textSecondary),
              const SizedBox(width: 8),
              Text(
                'Kembali ke Beranda',
                style: TextStyle(
                  color: _textSecondary,
                  fontSize: 15,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
